// ===================================================
// LINE Message Formatter ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI
// ===================================================

// ===================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL
// ===================================================
function safeUrl(url) {
  const dummy = "https://dummyimage.com/800x500/cccccc/ffffff&text=No+Chart";
  if (!url || typeof url !== "string") return dummy;
  const clean = url.trim();
  if (!/^https?:\/\//.test(clean)) return dummy;
  return clean;
}

// ===================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI
// ===================================================
function cleanAIText(text) {
  if (!text || typeof text !== 'string') {
    return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
  }

  let cleaned = text;

  // 1. ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  cleaned = cleaned.replace(/^(‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°|‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)‡∏Ñ‡∏£‡∏±‡∏ö.*?‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞(‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç|‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå).*?‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö\n+/s, '');
  
  // 2. ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô (---)
  cleaned = cleaned.replace(/\n*-{3,}\n*/g, '\n\n');
  
  // 3. ‡πÅ‡∏õ‡∏•‡∏á Markdown Headers (### ) ‡πÄ‡∏õ‡πá‡∏ô emoji + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  cleaned = cleaned.replace(/###\s*\*{0,2}(.+?)\*{0,2}/g, 'üìå $1');
  
  // 4. ‡∏•‡∏ö markdown formatting ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  cleaned = cleaned.replace(/\*{1,2}(.+?)\*{1,2}/g, '$1'); // **bold** ‡∏´‡∏£‡∏∑‡∏≠ *italic*
  cleaned = cleaned.replace(/\*/g, ''); // ‡∏•‡∏ö * ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  cleaned = cleaned.replace(/_{1,2}(.+?)_{1,2}/g, '$1'); // __bold__ ‡∏´‡∏£‡∏∑‡∏≠ _italic_
  
  // 5. ‡πÅ‡∏õ‡∏•‡∏á bullet points
  cleaned = cleaned.replace(/^\* /gm, '‚Ä¢ ');
  cleaned = cleaned.replace(/^- /gm, '‚Ä¢ ');
  
  // 6. ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢ line ‡∏ã‡πâ‡∏≠‡∏ô
  cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
  
  // 7. ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á
  cleaned = cleaned.trim();
  
  // 8. ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß (LINE Flex Message ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 3000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
  if (cleaned.length > 2500) {
    cleaned = cleaned.substring(0, 2500) + '...\n\nüìä [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏ó‡∏≠‡∏ô - ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô Google Sheets]';
  }
  
  return cleaned;
}

// ===================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å AI (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å - ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Å‡∏ß‡πà‡∏≤)
// ===================================================
function extractKeyInsights(text) {
  if (!text || typeof text !== 'string') {
    return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
  }

  const insights = [];
  
  // ‡∏´‡∏≤ Top 3 Products
  const top3Match = text.match(/ü•á\s*\*{0,2}1\.\s*(.+?)\*{0,2}\s*\n.*?‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:\*{0,2}\s*([\d,]+)\s*‡∏ö‡∏≤‡∏ó/s);
  if (top3Match) {
    insights.push(`ü•á ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ${top3Match[1]}`);
    insights.push(`üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${top3Match[2]} ‡∏ö‡∏≤‡∏ó`);
  }
  
  // ‡∏´‡∏≤‡πÇ‡∏≠‡∏Å‡∏≤‡∏™
  const opportunityMatch = text.match(/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á.*?:.*?\*{0,2}(.+?)\*{0,2}:/s);
  if (opportunityMatch) {
    insights.push(`\n‚ú® ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™: ${opportunityMatch[1]}`);
  }
  
  // ‡∏´‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  const recommendMatch = text.match(/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå.*?\n\n(.*?)(?:\n\n\*{0,2}üí∞|$)/s);
  if (recommendMatch) {
    let recommendations = recommendMatch[1];
    // ‡∏ï‡∏±‡∏î numbering ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
    recommendations = recommendations.replace(/\d+\.\s*\*{0,2}(.+?):\*{0,2}\s*/g, '‚Ä¢ $1: ');
    recommendations = recommendations.replace(/\n/g, ' ').substring(0, 300);
    insights.push(`\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n${recommendations}...`);
  }
  
  return insights.join('\n');
}

// üß© ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Node ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
const aiNode = $input.first().json;
const chartNode = $('Generate Charts1').first().json;
const processNode = $('Process Sales Data1').first().json;

// üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
const aiRawText = aiNode.text || aiNode.output || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
const totalRevenue = processNode.totalRevenue || 0;
const totalQuantity = processNode.totalQuantity || 0;
const topProducts = processNode.topProducts || [];

// ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡πÉ‡∏ô 2 ‡∏ß‡∏¥‡∏ò‡∏µ)
// ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
const aiResponse = cleanAIText(aiRawText);

// ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Å‡∏ß‡πà‡∏≤)
// const aiResponse = extractKeyInsights(aiRawText);

// üîç Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
console.log("ü§ñ AI Response (cleaned):", aiResponse.substring(0, 200) + "...");
console.log("üìè Length:", aiResponse.length);

// ‚úÖ ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å Generate Charts1
const barChartUrl = safeUrl(chartNode.barChartUrl || "https://dummyimage.com/800x500/cccccc/ffffff&text=No+Bar+Chart");
const lineChartUrl = safeUrl(chartNode.lineChartUrl || "https://dummyimage.com/800x500/cccccc/ffffff&text=No+Line+Chart");
const pieChartUrl = safeUrl(chartNode.pieChartUrl || "https://dummyimage.com/800x500/cccccc/ffffff&text=No+Pie+Chart");

// üñºÔ∏è URL ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Flex Message)
let chartUrl = safeUrl(chartNode.barChartUrl || chartNode.lineChartUrl || chartNode.pieChartUrl);

// üìã URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏•‡∏±‡∏Å
let sheetUrl = safeUrl("https://docs.google.com/spreadsheets/d/1T4TUZWwVJ36RHKG4gHrbaLh6OVSHIGaP9qneuderuT8");

// üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
const analysisDate = new Date().toLocaleString('th-TH', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
  hour12: false
});

// ===================================================
// üí≥ 1Ô∏è‚É£ Summary Card
// ===================================================
const summaryCard = {
  type: "flex",
  altText: "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
  contents: {
    type: "bubble",
    size: "mega",
    hero: {
      type: "box",
      layout: "vertical",
      contents: [
        { 
          type: "text", 
          text: "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", 
          size: "xxl", 
          weight: "bold", 
          color: "#FFFFFF", 
          align: "center" 
        },
        { 
          type: "text", 
          text: analysisDate, 
          size: "sm", 
          color: "#FFFFFF", 
          align: "center", 
          margin: "md", 
          wrap: true 
        }
      ],
      backgroundColor: "#3B82F6",
      paddingAll: "25px",
      spacing: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "box",
          layout: "horizontal",
          contents: [
            { type: "text", text: "üí∞", size: "xl", flex: 0 },
            {
              type: "box",
              layout: "vertical",
              contents: [
                { 
                  type: "text", 
                  text: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°", 
                  size: "sm", 
                  color: "#666666", 
                  weight: "bold" 
                },
                { 
                  type: "text", 
                  text: `${totalRevenue.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`, 
                  size: "xl", 
                  color: "#10B981", 
                  weight: "bold", 
                  margin: "xs" 
                }
              ],
              margin: "md"
            }
          ],
          backgroundColor: "#F0FDF4",
          cornerRadius: "md",
          paddingAll: "15px"
        },
        {
          type: "box",
          layout: "horizontal",
          contents: [
            { 
              type: "text", 
              text: "üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", 
              size: "md", 
              color: "#666666", 
              flex: 0 
            },
            { 
              type: "text", 
              text: `${totalQuantity.toLocaleString('th-TH')} ‡∏ä‡∏¥‡πâ‡∏ô`, 
              size: "md", 
              color: "#3B82F6", 
              weight: "bold", 
              align: "end" 
            }
          ],
          margin: "xl",
          paddingAll: "10px"
        },
        { 
          type: "separator", 
          margin: "xl", 
          color: "#E5E7EB" 
        },
        { 
          type: "text", 
          text: "üèÜ Top 3 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ", 
          size: "lg", 
          weight: "bold", 
          color: "#1F2937", 
          margin: "xl" 
        }
      ],
      paddingAll: "20px"
    },
    footer: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "button",
          style: "primary",
          height: "sm",
          action: { 
            type: "uri", 
            label: "üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô Google Sheets", 
            uri: sheetUrl 
          },
          color: "#2563EB"
        },
        { 
          type: "text", 
          text: "‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á üëá", 
          size: "sm", 
          color: "#6B7280", 
          align: "center", 
          weight: "bold", 
          margin: "md" 
        }
      ],
      paddingAll: "15px",
      backgroundColor: "#F9FAFB"
    }
  }
};

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Top 3
if (topProducts.length > 0) {
  topProducts.slice(0, 3).forEach((product, index) => {
    const [name, stats] = product;
    const medal = ["ü•á", "ü•à", "ü•â"][index] || "‚≠ê";
    const bgColor = ["#FEF3C7", "#E0E7FF", "#FFEDD5"][index] || "#FFFFFF";

    summaryCard.contents.body.contents.push({
      type: "box",
      layout: "horizontal",
      contents: [
        { type: "text", text: medal, size: "xl", flex: 0 },
        {
          type: "box",
          layout: "vertical",
          contents: [
            { 
              type: "text", 
              text: name, 
              size: "md", 
              color: "#1F2937", 
              weight: "bold", 
              wrap: true 
            },
            { 
              type: "text", 
              text: `${stats.quantity} ‡∏ä‡∏¥‡πâ‡∏ô | ${stats.revenue.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`, 
              size: "sm", 
              color: "#059669", 
              margin: "xs", 
              weight: "bold" 
            }
          ],
          margin: "md"
        }
      ],
      margin: "md",
      backgroundColor: bgColor,
      cornerRadius: "md",
      paddingAll: "12px"
    });
  });
}

// ===================================================
// ü§ñ AI Analysis Bubble
// ===================================================
const aiAnalysisBubble = {
  type: "flex",
  altText: "ü§ñ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå",
  contents: {
    type: "bubble",
    size: "mega",
    header: {
      type: "box",
      layout: "horizontal",
      contents: [
        { type: "text", text: "ü§ñ", size: "xl", flex: 0 },
        { 
          type: "text", 
          text: "‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", 
          weight: "bold", 
          size: "lg", 
          color: "#FFFFFF", 
          margin: "md" 
        }
      ],
      paddingAll: "20px",
      backgroundColor: "#8B5CF6"
    },
    body: { 
      type: "box", 
      layout: "vertical", 
      contents: [
        { 
          type: "text", 
          text: aiResponse, 
          wrap: true, 
          size: "sm", 
          color: "#1F2937" 
        }
      ], 
      paddingAll: "20px" 
    },
    footer: {
      type: "box",
      layout: "horizontal",
      contents: [
        { 
          type: "text", 
          text: "‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", 
          size: "sm", 
          color: "#10B981", 
          weight: "bold" 
        },
        { 
          type: "text", 
          text: new Date().toLocaleTimeString('th-TH'), 
          size: "xs", 
          color: "#6B7280", 
          align: "end" 
        }
      ],
      paddingAll: "15px"
    }
  }
};

// ===================================================
// ‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö LINE
// ===================================================
return [{
  json: {
    to: "U938a9be63e7f733655278aade4600a8a",
    messages: [
      summaryCard,
      { 
        type: "image", 
        originalContentUrl: barChartUrl, 
        previewImageUrl: barChartUrl 
      },
      { 
        type: "image", 
        originalContentUrl: lineChartUrl, 
        previewImageUrl: lineChartUrl 
      },
      { 
        type: "image", 
        originalContentUrl: pieChartUrl, 
        previewImageUrl: pieChartUrl 
      },
      aiAnalysisBubble
    ]
  }
}];