https://youtu.be/PvsuxwmQywc?si=xm9Kzgx1PgNEjLbA

---------------------////// Node AI Agent classify  /////////--------------------------

--#Prompt (User Message)#--

‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:** 
‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ RAG ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

**‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à:**
1. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î, ‡πÄ‡∏°‡∏ô‡∏π, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°, ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô) ‚Üí ‡∏ï‡∏≠‡∏ö "RAG"
2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‚Üí ‡∏ï‡∏≠‡∏ö "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
3. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ keyword ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏õ‡∏¥‡∏î", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏°‡∏ô‡∏π", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°", "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô" ‚Üí ‡∏ï‡∏≠‡∏ö "RAG"

**‡∏™‡∏¥‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:**
- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° input ‡∏Ñ‡∏∑‡∏≠: `{{ $json.body.events[0].message.text }}`
- ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: "RAG" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö", "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠", ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à:**
- "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á?" ‚Üí RAG
- "‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?" ‚Üí RAG
- "‡∏Å‡∏≤‡πÅ‡∏ü‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏á?" ‚Üí ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
- "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö" ‚Üí ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

---------------------////// Node AI Agent general  /////////--------------------------

--#Prompt (User Message)#--

‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢

‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 
‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏ï‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤
‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: "{{ $('only message').item.json.body.events[0].message.text }}"

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢

---------------------////// Node AI Agent RAG  /////////--------------------------

--#Prompt (User Message)#--
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡πÅ‡∏ä‡∏ó‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô LINE ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô ‡πÇ‡∏î‡∏¢ ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
`{{ $('only message').item.json.body.events[0].message.text }}`

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:

1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°

   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö
   - ‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏°‡∏ô‡∏π ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ

2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Supabase Vector Store ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

   - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô
   - ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö
   - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö

   - ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• ‡∏ü‡∏±‡∏á‡∏á‡πà‡∏≤‡∏¢
   - ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢
   - ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å
   - ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
   - ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏£‡∏±‡∏ö"

4. ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö

   - ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏Å‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î)
   - ‚ùì ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö"
   - ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö: "‡∏Ç‡∏≠‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö \n ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü"
   - ‚ùì ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   - ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏≠‡πà‡∏¢‡∏ñ‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö

---------------------////// Node Clean text  /////////--------------------------

// =======================
// 1. ‡∏£‡∏±‡∏ö input
// =======================
let rawData = $input.first().json.output ?? $input.first().json;

// =======================
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î string
// =======================
function cleanString(str) {
  if (!str) return "";
  // ‡∏•‡∏ö " , * ‡πÅ‡∏•‡∏∞ /
  let cleanText = str.replace(/["*\/]/g, '');
  // ‡∏•‡∏ö control chars ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô newline (\x0A)
  cleanText = cleanText.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ""); 
  // ‡πÅ‡∏õ‡∏•‡∏á literal \n ‡πÄ‡∏õ‡πá‡∏ô newline ‡∏à‡∏£‡∏¥‡∏á
  cleanText = cleanText.replace(/\\n/g, '\n');
  return cleanText.trim();
}

// =======================
// 3. ‡πÅ‡∏õ‡∏•‡∏á object ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° readable
// =======================
function objectToText(obj) {
  if (!obj) return "";
  return Object.entries(obj)
    .map(([key, value]) => {
      if (typeof value === "object") {
        return `${key}: ${JSON.stringify(value).replace(/\//g, '')}`;
      }
      return `${key}: ${value}`;
    })
    .join('\n');
}

// =======================
// 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î displayText
// =======================
let displayText = "";
if (typeof rawData === "string") {
  displayText = cleanString(rawData);
} else if (typeof rawData === "object") {
  displayText = objectToText(rawData);
} else {
  displayText = String(rawData);
}

// =======================
// 5. ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
// =======================
let lines = displayText.split('\n').filter(line => line.trim() !== "");

// =======================
// 6. ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏Ç‡∏≠‡∏á text objects ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Flex
// =======================
let textContents = lines.map(line => ({
  type: "text",
  text: line,
  size: "sm",
  color: "#555555",
  wrap: true
}));

// =======================
// 7. return replyToken + textContents
// =======================
return [{
  json: {
    replyToken: $('only message').first().json.body.events[0].replyToken,
    textContents: JSON.stringify(textContents)
  }
}];

---------------------////// Node send general to LINE  /////////--------------------------
-----------# JSON #--------------

{
  "replyToken": "{{ $json.replyToken }}",
  "messages": [
    {
      "type": "flex",
      "altText": "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
      "contents": {
        "type": "bubble",
        "body": {
          "type": "box",
          "layout": "vertical",
          "spacing": "md",
          "contents": [
            {
              "type": "text",
              "text": "üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
              "weight": "bold",
              "size": "xl",
              "color": "#1DB446"
            },
            {
              "type": "separator",
              "margin": "sm",
              "color": "#CCCCCC"
            },
            {
              "type": "box",
              "layout": "vertical",
              "margin": "md",
              "spacing": "sm",
              "contents": {{ $json.textContents }}
            },
            {
              "type": "separator",
              "margin": "md",
              "color": "#EEEEEE"
            },
            {
              "type": "box",
              "layout": "vertical",
              "margin": "md",
              "contents": [
                {
                  "type": "text",
                  "text": "‚ÑπÔ∏è ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô",
                  "size": "xs",
                  "wrap": true,
                  "color": "#AAAAAA"
                }
              ]
            }
          ]
        }
      }
    }
  ]
}

---------------------////// Node code to google sheet  /////////--------------------------

// ----- 1Ô∏è‚É£ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE Webhook -----
const webhookData = $('Webhook').first().json;
const events = webhookData.body?.events || webhookData.events || [];

// ----- 2Ô∏è‚É£ Mapping alias ‚Üí ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á -----
const menuAliases = {
  "Hot Drinks": {
    "‡∏•‡∏≤‡πÄ‡∏ï‡πâ": "‡∏•‡∏≤‡πÄ‡∏ï‡πâ",
    "‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô": "‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô",
    "‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤": "‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤",
    "‡∏Å‡∏≤‡πÅ‡∏ü‡∏£‡πâ‡∏≠‡∏ô": "‡∏Å‡∏≤‡πÅ‡∏ü‡∏£‡πâ‡∏≠‡∏ô",
    "‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà": "‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà",
    "‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã": "‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã",
    "‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï": "‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï",
    "‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏£‡πâ‡∏≠‡∏ô": "‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏£‡πâ‡∏≠‡∏ô"
  },
  "Cold Drinks": {
    "‡∏•‡∏≤‡πÄ‡∏ï‡πâ‡πÄ‡∏¢‡πá‡∏ô": "‡∏•‡∏≤‡πÄ‡∏ï‡πâ‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πÄ‡∏¢‡πá‡∏ô": "‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤‡πÄ‡∏¢‡πá‡∏ô": "‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πÄ‡∏¢‡πá‡∏ô": "‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏¢‡πá‡∏ô": "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏¢‡πá‡∏ô": "‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏ä‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô": "‡∏ä‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô",
    "‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡∏°‡∏∞‡∏ô‡∏≤‡∏ß": "‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡∏°‡∏∞‡∏ô‡∏≤‡∏ß",
    "‡πÇ‡∏ã‡∏î‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß": "‡πÇ‡∏ã‡∏î‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß"
  },
  "Dessert": {
    "‡πÄ‡∏Ñ‡πâ‡∏Å": "‡πÄ‡∏Ñ‡πâ‡∏Å",
    "‡∏Ñ‡∏£‡∏±‡∏ß‡∏ã‡∏≠‡∏á‡∏ï‡πå": "‡∏Ñ‡∏£‡∏±‡∏ß‡∏ã‡∏≠‡∏á‡∏ï‡πå",
    "‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà": "‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πà",
    "‡∏ä‡∏µ‡∏™‡πÄ‡∏Ñ‡πâ‡∏Å": "‡∏ä‡∏µ‡∏™‡πÄ‡∏Ñ‡πâ‡∏Å",
    "‡∏°‡∏±‡∏ü‡∏ü‡∏¥‡∏ô‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà": "‡∏°‡∏±‡∏ü‡∏ü‡∏¥‡∏ô‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà",
    "‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏ä‡πá‡∏≠‡∏Å‡∏ä‡∏¥‡∏û": "‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏ä‡πá‡∏≠‡∏Å‡∏ä‡∏¥‡∏û"
  }
};

// ----- 3Ô∏è‚É£ Levenshtein distance -----
function levenshtein(a, b) {
  const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      if (b[i - 1] === a[j - 1]) matrix[i][j] = matrix[i - 1][j - 1];
      else
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + 1
        );
    }
  }
  return matrix[b.length][a.length];
}

// ----- 4Ô∏è‚É£ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô match alias ‡πÄ‡∏ï‡πá‡∏° -----
function matchMenuStrict(text) {
  const cleanInput = text.trim().replace(/\s+/g, " ").replace(/\n|\t/g, "");
  for (const [category, aliases] of Object.entries(menuAliases)) {
    if (Object.prototype.hasOwnProperty.call(aliases, cleanInput)) {
      return { dishName: aliases[cleanInput], category };
    }
  }
  return null;
}

// ----- 5Ô∏è‚É£ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fuzzy suggestion -----
function getSuggestedDish(text) {
  const cleanInput = text.trim().replace(/\s+/g, " ").replace(/\n|\t/g, "");
  let bestMatch = null;
  let bestCategory = null;
  let bestScore = Infinity;

  for (const [category, aliases] of Object.entries(menuAliases)) {
    for (const [alias, name] of Object.entries(aliases)) {
      // ‡πÄ‡∏ä‡πá‡∏Ñ prefix ‡∏Å‡πà‡∏≠‡∏ô
      if (alias.startsWith(cleanInput)) {
        return { suggestedDishName: name, suggestedCategory: category };
      }

      // Levenshtein normalized
      const distance = levenshtein(cleanInput, alias) / Math.max(cleanInput.length, alias.length);
      if (distance < bestScore) {
        bestScore = distance;
        bestMatch = name;
        bestCategory = category;
      }
    }
  }

  return bestMatch ? { suggestedDishName: bestMatch, suggestedCategory: bestCategory } : null;
}


// ----- 6Ô∏è‚É£ classifyMessage ‡πÅ‡∏ö‡∏ö hybrid -----
function classifyMessage(text) {
  const t = text.toLowerCase();
  let result = {
    category: "General",
    intent: "General",
    sentiment: "Neutral",
    dishName: "",
    suggestedDishName: "",
    temperature: "",
    size: "",
    options: "",
    quantity: 0,
    faqTopic: "",
    faqAnswerSource: "",
    feedbackType: "",
    feedbackComment: "",
    ragSource: "",
    isParsed: false,
    error: ""
  };

  try {
    // Intent
    if (/‡πÄ‡∏≠‡∏≤|‡∏Ç‡∏≠|‡∏™‡∏±‡πà‡∏á|‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ/.test(t)) result.intent = "Order";

    // FAQ
    if (/‡∏£‡∏≤‡∏Ñ‡∏≤|‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á|‡πÄ‡∏°‡∏ô‡∏π|‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà|‡πÄ‡∏ö‡∏≠‡∏£‡πå/.test(t)) {
      result.category = "FAQ";
      result.intent = "Inquiry";
      result.faqTopic = "GeneralInfo";
      result.isParsed = true;
    }

    // Strict match
    const match = matchMenuStrict(text);
    if (match) {
      result.category = match.category;
      result.intent = "OrderIntent";
      result.dishName = match.dishName;
      result.suggestedDishName = match.dishName;
      result.size = "Regular";
      result.quantity = 1;
      if (match.category === "Hot Drinks") result.temperature = "‡∏£‡πâ‡∏≠‡∏ô";
      else if (match.category === "Cold Drinks") result.temperature = "‡πÄ‡∏¢‡πá‡∏ô";
      result.isParsed = true;
    } else {
      // Fuzzy match
      const suggestion = getSuggestedDish(text);
      if (suggestion) {
        result.suggestedDishName = suggestion.suggestedDishName;
        result.dishName = suggestion.suggestedDishName;
        result.category = suggestion.suggestedCategory || "General";
        result.size = "Regular";
        result.quantity = 1;
        if (suggestion.suggestedCategory === "Hot Drinks") result.temperature = "‡∏£‡πâ‡∏≠‡∏ô";
        else if (suggestion.suggestedCategory === "Cold Drinks") result.temperature = "‡πÄ‡∏¢‡πá‡∏ô";
        result.isParsed = true;
      }
    }

    // Feedback
    if (/‡πÑ‡∏°‡πà‡∏≠‡∏£‡πà‡∏≠‡∏¢|‡∏Ç‡∏°‡πÑ‡∏õ|‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏õ|‡∏ä‡πâ‡∏≤/.test(t)) {
      result.category = "Feedback";
      result.intent = "Feedback";
      result.feedbackComment = text;
      result.sentiment = "Negative";
      result.isParsed = true;
    }

    // Options
    if (/‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•/.test(t)) {
      result.options = "‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•";
    }

  } catch (err) {
    result.error = err.message;
  }

  return result;
}

// ----- 7Ô∏è‚É£ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏∏‡∏Å event -----
const results = [];

for (const event of events) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ text message
  const messageText = event.message?.text || "";
  if (!messageText) continue;

  const userId = event.source?.userId || event.source?.groupId || "U0000";
  const messageId = event.message?.id || "";
  const replyToken = event.replyToken || "";
  const timestamp = event.timestamp ? new Date(event.timestamp).toISOString() : new Date().toISOString();
  const sessionId = `${userId}_${Date.now()}`; // ‡πÉ‡∏ä‡πâ timestamp ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥

  const classified = classifyMessage(messageText);

  results.push({
    json: {
      timestamp,
      sessionId,
      userId,
      messageId,
      replyToken,
      originalText: messageText,
      category: classified.category,
      intent: classified.intent,
      sentiment: classified.sentiment,
      dishName: classified.dishName,
      suggestedDishName: classified.suggestedDishName,
      temperature: classified.temperature,
      size: classified.size,
      options: classified.options,
      quantity: classified.quantity,
      faqTopic: classified.faqTopic,
      faqAnswerSource: classified.faqAnswerSource,
      feedbackType: classified.feedbackType,
      feedbackComment: classified.feedbackComment,
      ragSource: classified.ragSource,
      isParsed: classified.isParsed,
      error: classified.error
    }
  });
}

return results;



