https://youtu.be/PvsuxwmQywc?si=xm9Kzgx1PgNEjLbA

---------------------////// Node AI Agent classify  /////////--------------------------

--#Prompt (User Message)#--

à¸„à¸¸à¸“à¸„à¸·à¸­à¸£à¸°à¸šà¸šà¸ˆà¸³à¹à¸™à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¹‰à¸²à¸™à¸à¸²à¹à¸Ÿ

**à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“:** 
à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¸§à¹ˆà¸² à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ RAG à¸«à¸£à¸·à¸­à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›

**à¸à¸Žà¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ:**
1. à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‰à¸žà¸²à¸°à¸ˆà¸²à¸à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¹€à¸­à¸à¸ªà¸²à¸£ (à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸”-à¸›à¸´à¸”, à¹€à¸¡à¸™à¸¹, à¸£à¸²à¸„à¸², à¸ªà¹ˆà¸§à¸™à¸œà¸ªà¸¡, à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™) â†’ à¸•à¸­à¸š "RAG"
2. à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸—à¸±à¸à¸—à¸²à¸¢ à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸ à¸«à¸£à¸·à¸­à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™à¸—à¸±à¹ˆà¸§à¹„à¸› â†’ à¸•à¸­à¸š "à¸—à¸±à¹ˆà¸§à¹„à¸›"
3. à¸–à¹‰à¸²à¸¡à¸µ keyword à¹€à¸Šà¹ˆà¸™ "à¹€à¸›à¸´à¸”", "à¹€à¸§à¸¥à¸²", "à¹€à¸¡à¸™à¸¹", "à¸£à¸²à¸„à¸²", "à¸ªà¹ˆà¸§à¸™à¸œà¸ªà¸¡", "à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™" â†’ à¸•à¸­à¸š "RAG"

**à¸ªà¸´à¹ˆà¸‡à¸ªà¸³à¸„à¸±à¸:**
- à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ input à¸„à¸·à¸­: `{{ $json.body.events[0].message.text }}`
- à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹„à¸”à¹‰à¹à¸„à¹ˆà¸«à¸™à¸¶à¹ˆà¸‡à¸„à¸³à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™: "RAG" à¸«à¸£à¸·à¸­ "à¸—à¸±à¹ˆà¸§à¹„à¸›"
- à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸„à¸³à¸­à¸·à¹ˆà¸™ à¹† à¹€à¸Šà¹ˆà¸™ "à¸™à¸µà¹ˆà¸„à¸·à¸­à¸„à¸³à¸•à¸­à¸š", "à¸„à¸³à¸•à¸­à¸šà¸„à¸·à¸­", à¸«à¸£à¸·à¸­à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡

**à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ:**
- "à¸£à¹‰à¸²à¸™à¹€à¸›à¸´à¸”à¸à¸µà¹ˆà¹‚à¸¡à¸‡?" â†’ RAG
- "à¹€à¸¡à¸™à¸¹à¸¡à¸µà¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡?" â†’ RAG
- "à¸à¸²à¹à¸Ÿà¸£à¸ªà¸Šà¸²à¸•à¸´à¸¢à¸±à¸‡à¹„à¸‡?" â†’ à¸—à¸±à¹ˆà¸§à¹„à¸›
- "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š" â†’ à¸—à¸±à¹ˆà¸§à¹„à¸›

---------------------////// Node AI Agent general  /////////--------------------------

--#Prompt (User Message)#--

à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸—à¸µà¹ˆà¸ªà¸¸à¸ à¸²à¸ž à¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£ à¹à¸¥à¸°à¹€à¸«à¸¡à¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¸Šà¸²à¸¢

à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸› 
à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡à¸ªà¸¸à¸ à¸²à¸ž à¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£ à¹à¸•à¹ˆà¸•à¸£à¸‡à¹„à¸›à¸•à¸£à¸‡à¸¡à¸²
à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰ à¹ƒà¸«à¹‰à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸«à¸£à¸·à¸­à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š
à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸„à¸³à¸•à¸­à¸š à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¹„à¸›à¸•à¸£à¸‡à¸¡à¸²à¹à¸¥à¸°à¹à¸™à¸°à¸™à¸³à¸§à¸´à¸˜à¸µà¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥

à¸„à¸³à¸–à¸²à¸¡: "{{ $('only message').item.json.body.events[0].message.text }}"

à¸à¸£à¸¸à¸“à¸²à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ à¸—à¸±à¸™à¸—à¸µ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸±à¸à¸—à¸²à¸¢

---------------------////// Node AI Agent RAG  /////////--------------------------

--#Prompt (User Message)#--
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸•à¸­à¸šà¹à¸Šà¸—à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¹ƒà¸™ LINE à¸‚à¸­à¸‡à¸£à¹‰à¸²à¸™à¸à¸²à¹à¸Ÿ
à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸”à¹‰à¸§à¸¢à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸ˆà¸²à¸à¸£à¹‰à¸²à¸™ à¹‚à¸”à¸¢ à¹„à¸¡à¹ˆà¹à¸•à¹ˆà¸‡à¹€à¸•à¸´à¸¡à¹€à¸à¸´à¸™à¸ˆà¸£à¸´à¸‡

à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰:
`{{ $('only message').item.json.body.events[0].message.text }}`

à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™:

1. à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¸—à¸³à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸„à¸³à¸–à¸²à¸¡

   - à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸žà¸´à¸¡à¸žà¹Œà¸œà¸´à¸”à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸•à¸à¸«à¸¥à¹ˆà¸™ à¹à¸¥à¹‰à¸§à¹à¸à¹‰à¹„à¸‚à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¸£à¸±à¸š
   - à¸•à¸µà¸„à¸§à¸²à¸¡à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸£à¹‰à¸²à¸™ à¹€à¸Šà¹ˆà¸™ à¸ªà¸´à¸™à¸„à¹‰à¸² à¹€à¸¡à¸™à¸¹ à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™ à¸šà¸£à¸´à¸à¸²à¸£ à¹€à¸§à¸¥à¸²à¸—à¸³à¸à¸²à¸£ à¸«à¸£à¸·à¸­à¸„à¸³à¸–à¸²à¸¡à¸­à¸·à¹ˆà¸™à¹†

2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ Supabase Vector Store à¸à¹ˆà¸­à¸™à¸•à¸­à¸šà¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡

   - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸›à¸£à¸±à¸šà¹à¸¥à¹‰à¸§à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡à¸£à¹‰à¸²à¸™
   - à¸–à¹‰à¸²à¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸•à¸£à¸‡à¸à¸±à¸™ à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¸±à¹‰à¸™à¹ƒà¸™à¸à¸²à¸£à¸•à¸­à¸š
   - à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸•à¸£à¸‡ à¹ƒà¸«à¹‰à¸„à¹‰à¸™à¸«à¸²à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹à¸¥à¹‰à¸§à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡

3. à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸š

   - à¹€à¸£à¸µà¸¢à¸šà¹€à¸£à¸µà¸¢à¸‡à¹ƒà¸«à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´ à¸­à¹ˆà¸²à¸™à¸¥à¸·à¹ˆà¸™à¹„à¸«à¸¥ à¸Ÿà¸±à¸‡à¸‡à¹ˆà¸²à¸¢
   - à¸ˆà¸±à¸”à¸¥à¸³à¸”à¸±à¸šà¸›à¸£à¸°à¹‚à¸¢à¸„à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸¥à¸°à¸ªà¸¥à¸§à¸¢à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢
   - à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸„à¸³à¸‹à¹‰à¸³à¹à¸¥à¸°à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸‹à¹‰à¸³à¸‹à¸²à¸
   - à¹à¸šà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸Šà¸±à¸”à¹€à¸ˆà¸™
   - à¸›à¸´à¸”à¸—à¹‰à¸²à¸¢à¸—à¸¸à¸à¸›à¸£à¸°à¹‚à¸¢à¸„à¸”à¹‰à¸§à¸¢à¸„à¸³à¸§à¹ˆà¸² "à¸„à¸£à¸±à¸š"

4. à¸à¸Žà¸à¸²à¸£à¸•à¸­à¸š

   - âŒ à¸«à¹‰à¸²à¸¡à¹€à¸”à¸²à¸«à¸£à¸·à¸­à¹à¸•à¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸ˆà¸£à¸´à¸‡ (à¸¢à¸à¹€à¸§à¹‰à¸™à¹à¸à¹‰à¸žà¸´à¸¡à¸žà¹Œà¸œà¸´à¸”)
   - â“ à¸–à¹‰à¸²à¸„à¸³à¸–à¸²à¸¡à¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸£à¹‰à¸²à¸™ à¹ƒà¸«à¹‰à¸•à¸­à¸š: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¹ƒà¸™à¸„à¸§à¸²à¸¡à¹„à¸¡à¹ˆà¸ªà¸°à¸”à¸§à¸à¸„à¸£à¸±à¸š"
   - âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¹ƒà¸«à¹‰à¸•à¸­à¸š: "à¸‚à¸­à¸—à¸§à¸™à¸„à¸³à¸–à¸²à¸¡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¹„à¸”à¹‰à¹„à¸«à¸¡à¸„à¸£à¸±à¸š \n à¸£à¹‰à¸²à¸™à¸‚à¸­à¸‡à¹€à¸£à¸²à¸„à¸·à¸­à¸£à¹‰à¸²à¸™à¸à¸²à¹à¸Ÿ"
   - â“ à¸–à¹‰à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™à¹„à¸¡à¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹ƒà¸«à¹‰à¹€à¸ªà¸™à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸žà¸£à¹‰à¸­à¸¡à¸–à¸²à¸¡à¸à¸¥à¸±à¸šà¸§à¹ˆà¸²à¹ƒà¸Šà¹ˆà¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
   - âŒ à¸«à¹‰à¸²à¸¡à¹€à¸­à¹ˆà¸¢à¸–à¸¶à¸‡à¸Šà¸·à¹ˆà¸­à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸™à¸à¸²à¸£à¸•à¸­à¸š

---------------------////// Node Clean text  /////////--------------------------

// =======================
// 1. à¸£à¸±à¸š input
// =======================
let rawData = $input.first().json.output ?? $input.first().json;

// =======================
// 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸—à¸³à¸„à¸§à¸²à¸¡à¸ªà¸°à¸­à¸²à¸” string
// =======================
function cleanString(str) {
  if (!str) return "";
  // à¸¥à¸š " , * à¹à¸¥à¸° /
  let cleanText = str.replace(/["*\/]/g, '');
  // à¸¥à¸š control chars à¸¢à¸à¹€à¸§à¹‰à¸™ newline (\x0A)
  cleanText = cleanText.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ""); 
  // à¹à¸›à¸¥à¸‡ literal \n à¹€à¸›à¹‡à¸™ newline à¸ˆà¸£à¸´à¸‡
  cleanText = cleanText.replace(/\\n/g, '\n');
  return cleanText.trim();
}

// =======================
// 3. à¹à¸›à¸¥à¸‡ object à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ readable
// =======================
function objectToText(obj) {
  if (!obj) return "";
  return Object.entries(obj)
    .map(([key, value]) => {
      if (typeof value === "object") {
        return `${key}: ${JSON.stringify(value).replace(/\//g, '')}`;
      }
      return `${key}: ${value}`;
    })
    .join('\n');
}

// =======================
// 4. à¸à¸³à¸«à¸™à¸” displayText
// =======================
let displayText = "";
if (typeof rawData === "string") {
  displayText = cleanString(rawData);
} else if (typeof rawData === "object") {
  displayText = objectToText(rawData);
} else {
  displayText = String(rawData);
}

// =======================
// 5. à¹à¸¢à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™ array à¸‚à¸­à¸‡à¸šà¸£à¸£à¸—à¸±à¸”
// =======================
let lines = displayText.split('\n').filter(line => line.trim() !== "");

// =======================
// 6. à¸ªà¸£à¹‰à¸²à¸‡ array à¸‚à¸­à¸‡ text objects à¸ªà¸³à¸«à¸£à¸±à¸š Flex
// =======================
let textContents = lines.map(line => ({
  type: "text",
  text: line,
  size: "sm",
  color: "#555555",
  wrap: true
}));

// =======================
// 7. return replyToken + textContents
// =======================
return [{
  json: {
    replyToken: $('only message').first().json.body.events[0].replyToken,
    textContents: JSON.stringify(textContents)
  }
}];

---------------------////// Node send general to LINE  /////////--------------------------
-----------# JSON #--------------

{
  "replyToken": "{{ $json.replyToken }}",
  "messages": [
    {
      "type": "flex",
      "altText": "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›",
      "contents": {
        "type": "bubble",
        "body": {
          "type": "box",
          "layout": "vertical",
          "spacing": "md",
          "contents": [
            {
              "type": "text",
              "text": "ðŸ“Œ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›",
              "weight": "bold",
              "size": "xl",
              "color": "#1DB446"
            },
            {
              "type": "separator",
              "margin": "sm",
              "color": "#CCCCCC"
            },
            {
              "type": "box",
              "layout": "vertical",
              "margin": "md",
              "spacing": "sm",
              "contents": {{ $json.textContents }}
            },
            {
              "type": "separator",
              "margin": "md",
              "color": "#EEEEEE"
            },
            {
              "type": "box",
              "layout": "vertical",
              "margin": "md",
              "contents": [
                {
                  "type": "text",
                  "text": "â„¹ï¸ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¸”à¸•à¹ˆà¸­à¸à¹ˆà¸²à¸¢à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™",
                  "size": "xs",
                  "wrap": true,
                  "color": "#AAAAAA"
                }
              ]
            }
          ]
        }
      }
    }
  ]
}

---------------------////// Node code to google sheet  /////////--------------------------

// ----- 1ï¸âƒ£ à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ LINE Webhook -----
const webhookData = $('Webhook').first().json;
const events = webhookData.body?.events || webhookData.events || [];

// ----- 2ï¸âƒ£ Mapping alias â†’ à¸Šà¸·à¹ˆà¸­à¸ˆà¸£à¸´à¸‡ -----
const menuAliases = {
  "Hot Drinks": {
    "à¸¥à¸²à¹€à¸•à¹‰": "à¸¥à¸²à¹€à¸•à¹‰",
    "à¸„à¸²à¸›à¸¹à¸Šà¸´à¹‚à¸™": "à¸„à¸²à¸›à¸¹à¸Šà¸´à¹‚à¸™",
    "à¸¡à¸­à¸„à¸„à¹ˆà¸²": "à¸¡à¸­à¸„à¸„à¹ˆà¸²",
    "à¸à¸²à¹à¸Ÿà¸£à¹‰à¸­à¸™": "à¸à¸²à¹à¸Ÿà¸£à¹‰à¸­à¸™",
    "à¸­à¹€à¸¡à¸£à¸´à¸à¸²à¹‚à¸™à¹ˆ": "à¸­à¹€à¸¡à¸£à¸´à¸à¸²à¹‚à¸™à¹ˆ",
    "à¹€à¸­à¸ªà¹€à¸žà¸£à¸ªà¹‚à¸‹": "à¹€à¸­à¸ªà¹€à¸žà¸£à¸ªà¹‚à¸‹",
    "à¸Šà¹‡à¸­à¸„à¹‚à¸à¹à¸¥à¸•": "à¸Šà¹‡à¸­à¸„à¹‚à¸à¹à¸¥à¸•",
    "à¸¡à¸±à¸—à¸‰à¸°à¸£à¹‰à¸­à¸™": "à¸¡à¸±à¸—à¸‰à¸°à¸£à¹‰à¸­à¸™"
  },
  "Cold Drinks": {
    "à¸¥à¸²à¹€à¸•à¹‰à¹€à¸¢à¹‡à¸™": "à¸¥à¸²à¹€à¸•à¹‰à¹€à¸¢à¹‡à¸™",
    "à¸„à¸²à¸›à¸¹à¸Šà¸´à¹‚à¸™à¹€à¸¢à¹‡à¸™": "à¸„à¸²à¸›à¸¹à¸Šà¸´à¹‚à¸™à¹€à¸¢à¹‡à¸™",
    "à¸¡à¸­à¸„à¸„à¹ˆà¸²à¹€à¸¢à¹‡à¸™": "à¸¡à¸­à¸„à¸„à¹ˆà¸²à¹€à¸¢à¹‡à¸™",
    "à¸­à¹€à¸¡à¸£à¸´à¸à¸²à¹‚à¸™à¹€à¸¢à¹‡à¸™": "à¸­à¹€à¸¡à¸£à¸´à¸à¸²à¹‚à¸™à¹€à¸¢à¹‡à¸™",
    "à¸Šà¸²à¹€à¸‚à¸µà¸¢à¸§à¹€à¸¢à¹‡à¸™": "à¸Šà¸²à¹€à¸‚à¸µà¸¢à¸§à¹€à¸¢à¹‡à¸™",
    "à¸Šà¸²à¹„à¸—à¸¢à¹€à¸¢à¹‡à¸™": "à¸Šà¸²à¹„à¸—à¸¢à¹€à¸¢à¹‡à¸™",
    "à¸Šà¸²à¸¡à¸°à¸™à¸²à¸§à¹€à¸¢à¹‡à¸™": "à¸Šà¸²à¸¡à¸°à¸™à¸²à¸§à¹€à¸¢à¹‡à¸™",
    "à¸™à¹‰à¸³à¸œà¸¶à¹‰à¸‡à¸¡à¸°à¸™à¸²à¸§": "à¸™à¹‰à¸³à¸œà¸¶à¹‰à¸‡à¸¡à¸°à¸™à¸²à¸§",
    "à¹‚à¸‹à¸”à¸²à¸¡à¸°à¸™à¸²à¸§": "à¹‚à¸‹à¸”à¸²à¸¡à¸°à¸™à¸²à¸§"
  },
  "Dessert": {
    "à¹€à¸„à¹‰à¸": "à¹€à¸„à¹‰à¸",
    "à¸„à¸£à¸±à¸§à¸‹à¸­à¸‡à¸•à¹Œ": "à¸„à¸£à¸±à¸§à¸‹à¸­à¸‡à¸•à¹Œ",
    "à¸šà¸£à¸²à¸§à¸™à¸µà¹ˆ": "à¸šà¸£à¸²à¸§à¸™à¸µà¹ˆ",
    "à¸Šà¸µà¸ªà¹€à¸„à¹‰à¸": "à¸Šà¸µà¸ªà¹€à¸„à¹‰à¸",
    "à¸¡à¸±à¸Ÿà¸Ÿà¸´à¸™à¸šà¸¥à¸¹à¹€à¸šà¸­à¸£à¹Œà¸£à¸µà¹ˆ": "à¸¡à¸±à¸Ÿà¸Ÿà¸´à¸™à¸šà¸¥à¸¹à¹€à¸šà¸­à¸£à¹Œà¸£à¸µà¹ˆ",
    "à¸„à¸¸à¸à¸à¸µà¹‰à¸Šà¹‡à¸­à¸à¸Šà¸´à¸ž": "à¸„à¸¸à¸à¸à¸µà¹‰à¸Šà¹‡à¸­à¸à¸Šà¸´à¸ž"
  }
};

// ----- 3ï¸âƒ£ Levenshtein distance -----
function levenshtein(a, b) {
  const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      if (b[i - 1] === a[j - 1]) matrix[i][j] = matrix[i - 1][j - 1];
      else
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + 1
        );
    }
  }
  return matrix[b.length][a.length];
}

// ----- 4ï¸âƒ£ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ match alias à¹€à¸•à¹‡à¸¡ -----
function matchMenuStrict(text) {
  const cleanInput = text.trim().replace(/\s+/g, " ").replace(/\n|\t/g, "");
  for (const [category, aliases] of Object.entries(menuAliases)) {
    if (Object.prototype.hasOwnProperty.call(aliases, cleanInput)) {
      return { dishName: aliases[cleanInput], category };
    }
  }
  return null;
}

// ----- 5ï¸âƒ£ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ fuzzy suggestion -----
function getSuggestedDish(text) {
  const cleanInput = text.trim().replace(/\s+/g, " ").replace(/\n|\t/g, "");
  let bestMatch = null;
  let bestCategory = null;
  let bestScore = Infinity;

  for (const [category, aliases] of Object.entries(menuAliases)) {
    for (const [alias, name] of Object.entries(aliases)) {
      // à¹€à¸Šà¹‡à¸„ prefix à¸à¹ˆà¸­à¸™
      if (alias.startsWith(cleanInput)) {
        return { suggestedDishName: name, suggestedCategory: category };
      }

      // Levenshtein normalized
      const distance = levenshtein(cleanInput, alias) / Math.max(cleanInput.length, alias.length);
      if (distance < bestScore) {
        bestScore = distance;
        bestMatch = name;
        bestCategory = category;
      }
    }
  }

  return bestMatch ? { suggestedDishName: bestMatch, suggestedCategory: bestCategory } : null;
}


// ----- 6ï¸âƒ£ classifyMessage à¹à¸šà¸š hybrid -----
function classifyMessage(text) {
  const t = text.toLowerCase();
  let result = {
    category: "General",
    intent: "General",
    sentiment: "Neutral",
    dishName: "",
    suggestedDishName: "",
    temperature: "",
    size: "",
    options: "",
    quantity: 0,
    faqTopic: "",
    faqAnswerSource: "",
    feedbackType: "",
    feedbackComment: "",
    ragSource: "",
    isParsed: false,
    error: ""
  };

  try {
    // Intent
    if (/à¹€à¸­à¸²|à¸‚à¸­|à¸ªà¸±à¹ˆà¸‡|à¸­à¸¢à¸²à¸à¹„à¸”à¹‰/.test(t)) result.intent = "Order";

    // FAQ
    if (/à¸£à¸²à¸„à¸²|à¸à¸µà¹ˆà¹‚à¸¡à¸‡|à¹€à¸¡à¸™à¸¹|à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ|à¹€à¸šà¸­à¸£à¹Œ/.test(t)) {
      result.category = "FAQ";
      result.intent = "Inquiry";
      result.faqTopic = "GeneralInfo";
      result.isParsed = true;
    }

    // Strict match
    const match = matchMenuStrict(text);
    if (match) {
      result.category = match.category;
      result.intent = "OrderIntent";
      result.dishName = match.dishName;
      result.suggestedDishName = match.dishName;
      result.size = "Regular";
      result.quantity = 1;
      if (match.category === "Hot Drinks") result.temperature = "à¸£à¹‰à¸­à¸™";
      else if (match.category === "Cold Drinks") result.temperature = "à¹€à¸¢à¹‡à¸™";
      result.isParsed = true;
    } else {
      // Fuzzy match
      const suggestion = getSuggestedDish(text);
      if (suggestion) {
        result.suggestedDishName = suggestion.suggestedDishName;
        result.dishName = suggestion.suggestedDishName;
        result.category = suggestion.suggestedCategory || "General";
        result.size = "Regular";
        result.quantity = 1;
        if (suggestion.suggestedCategory === "Hot Drinks") result.temperature = "à¸£à¹‰à¸­à¸™";
        else if (suggestion.suggestedCategory === "Cold Drinks") result.temperature = "à¹€à¸¢à¹‡à¸™";
        result.isParsed = true;
      }
    }

    // Feedback
    if (/à¹„à¸¡à¹ˆà¸­à¸£à¹ˆà¸­à¸¢|à¸‚à¸¡à¹„à¸›|à¸«à¸§à¸²à¸™à¹„à¸›|à¸Šà¹‰à¸²/.test(t)) {
      result.category = "Feedback";
      result.intent = "Feedback";
      result.feedbackComment = text;
      result.sentiment = "Negative";
      result.isParsed = true;
    }

    // Options
    if (/à¹„à¸¡à¹ˆà¹ƒà¸ªà¹ˆà¸™à¹‰à¸³à¸•à¸²à¸¥/.test(t)) {
      result.options = "à¹„à¸¡à¹ˆà¹ƒà¸ªà¹ˆà¸™à¹‰à¸³à¸•à¸²à¸¥";
    }

  } catch (err) {
    result.error = err.message;
  }

  return result;
}

// ----- 7ï¸âƒ£ à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸—à¸¸à¸ event -----
const results = [];

for (const event of events) {
  // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸¡à¸µ text message
  const messageText = event.message?.text || "";
  if (!messageText) continue;

  const userId = event.source?.userId || event.source?.groupId || "U0000";
  const messageId = event.message?.id || "";
  const replyToken = event.replyToken || "";
  const timestamp = event.timestamp ? new Date(event.timestamp).toISOString() : new Date().toISOString();
  const sessionId = `${userId}_${Date.now()}`; // à¹ƒà¸Šà¹‰ timestamp à¹€à¸•à¹‡à¸¡à¹€à¸žà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸‹à¹‰à¸³

  const classified = classifyMessage(messageText);

  results.push({
    json: {
      timestamp,
      sessionId,
      userId,
      messageId,
      replyToken,
      originalText: messageText,
      category: classified.category,
      intent: classified.intent,
      sentiment: classified.sentiment,
      dishName: classified.dishName,
      suggestedDishName: classified.suggestedDishName,
      temperature: classified.temperature,
      size: classified.size,
      options: classified.options,
      quantity: classified.quantity,
      faqTopic: classified.faqTopic,
      faqAnswerSource: classified.faqAnswerSource,
      feedbackType: classified.feedbackType,
      feedbackComment: classified.feedbackComment,
      ragSource: classified.ragSource,
      isParsed: classified.isParsed,
      error: classified.error
    }
  });
}

return results;



